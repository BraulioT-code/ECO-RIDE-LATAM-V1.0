# Puerto del Gateway (el puerto p\uFFFDblico principal de nuestra app)
server.port=8080

# -- Conexi\uFFFDn a Eureka --
# Le decimos d\uFFFDnde est\uFFFD Eureka para que pueda buscar servicios
eureka.client.service-url.defaultZone=http://localhost:8761/eureka/

# -- Configuraci\uFFFDn de Rutas del Gateway --
spring.cloud.gateway.discovery.locator.enabled=true
spring.cloud.gateway.discovery.locator.lower-case-service-id=true

# Definimos rutas. Ejemplo:
# Todo lo que llegue a /api/trips/** ser\uFFFD redirigido a
# un servicio registrado en Eureka como "trip-service"
spring.cloud.gateway.routes[0].id=trip-service-route
spring.cloud.gateway.routes[0].uri=lb://trip-service
spring.cloud.gateway.routes[0].predicates[0]=Path=/api/trips/**

# -- Configuraci\uFFFDn de Seguridad (Keycloak) --
# 1. Le decimos d\uFFFDnde est\uFFFD nuestro servidor Keycloak
spring.security.oauth2.resourceserver.jwt.issuer-uri=http://localhost:8888/realms/ecoride

# 2. Le decimos c\uFFFDmo encontrar la "audiencia" (el client_id)
# spring.security.oauth2.resourceserver.jwt.audiences=eco-gateway

# -- Configuraci\uFFFDn de Observabilidad --
# Para que las m\uFFFDtricas de Actuator (como /health) est\uFFFDn disponibles
management.endpoints.web.exposure.include=*

# ------------------------------------------------------------------
# FILTROS POR DEFECTO:
# 1. Filtro para reescribir la URL (quitamos el /api)
spring.cloud.gateway.default-filters[0]=RewritePath=/api/(?<segment>.*), /$\\{segment}

# 2. Filtro Custom para Token Relay: Usar el nombre exacto del m\u00E9todo @Bean
spring.cloud.gateway.default-filters[1]=keycloakTokenRelayFilter  # <-- \u00A1CAMBIO A MIN\u00DASCULAS!

# 3. Ruta para Passenger Service
spring.cloud.gateway.routes[2].id=passenger-service
spring.cloud.gateway.routes[2].uri=lb://PASSENGER-SERVICE
spring.cloud.gateway.routes[2].predicates[0]=Path=/api/passenger/**
# Filtro para limpiar el prefijo /api/passenger del request antes de enviarlo al servicio
spring.cloud.gateway.routes[2].filters[0]=RewritePath=/api/passenger/(?<segment>.*), /$\\{segment}

# Para que Prometheus pueda leer las m\uFFFDtricas
management.endpoint.metrics.enabled=true
management.endpoint.prometheus.enabled=true